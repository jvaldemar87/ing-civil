---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface Props {
  projectId: string;
  projectTitle: string;
  locale: 'es' | 'en';
}

const { projectId, projectTitle, locale } = Astro.props;

// Load all images from projects-detail directory using import.meta.glob
const allImages = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/projects-detail/**/*.{avif,jpg,png,jpeg}',
  { eager: true }
);

// Filter images for this specific project
const projectImages = Object.entries(allImages)
  .filter(([path]) => path.includes(`/${projectId}/`))
  .sort(([pathA], [pathB]) => pathA.localeCompare(pathB)) // Sort by filename
  .map(([_, module]) => module.default);

const hasImages = projectImages.length > 0;
---

{hasImages ? (
  <section class="mb-12">
    <!-- Swiper Gallery -->
    <div class="swiper project-gallery rounded-lg overflow-hidden">
      <div class="swiper-wrapper">
        {projectImages.map((image, index) => (
          <div class="swiper-slide">
            <div class="aspect-video bg-gray-100">
              <Image
                src={image}
                alt={`${projectTitle} - ${locale === 'es' ? 'Imagen' : 'Image'} ${index + 1}`}
                class="w-full h-full object-cover"
                loading={index === 0 ? 'eager' : 'lazy'}
                quality={85}
                widths={[400, 800, 1200]}
                sizes="(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1200px"
              />
            </div>
          </div>
        ))}
      </div>
      
      <!-- Navigation -->
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
      
      <!-- Pagination -->
      <div class="swiper-pagination"></div>
      
      <!-- Counter -->
      <div class="absolute bottom-4 right-4 z-10 bg-black/70 text-white px-3 py-1 rounded-md font-mono text-sm">
        <span class="current-slide">1</span>
        <span class="mx-1">{locale === 'es' ? 'de' : 'of'}</span>
        <span>{projectImages.length}</span>
      </div>
    </div>
  </section>
) : (
  <!-- Placeholder when no images -->
  <section class="mb-12">
    <div class="bg-blueprint-blue/5 border-2 border-blueprint-blue/20 rounded-lg p-12 text-center blueprint-grid">
      <svg class="w-16 h-16 mx-auto mb-4 text-blueprint-blue/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
      </svg>
      <p class="text-gray-600 font-mono text-sm">
        {locale === 'es' ? 'Imágenes próximamente' : 'Images coming soon'}
      </p>
    </div>
  </section>
)}

<style>
  /* Blueprint grid for placeholder */
  .blueprint-grid {
    background-image: 
      linear-gradient(to right, rgba(0, 71, 171, 0.05) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(0, 71, 171, 0.05) 1px, transparent 1px);
    background-size: 20px 20px;
  }

  /* Swiper customization */
  .project-gallery {
    position: relative;
  }

  .project-gallery :global(.swiper-button-prev),
  .project-gallery :global(.swiper-button-next) {
    color: #0047AB;
    background: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .project-gallery :global(.swiper-button-prev:after),
  .project-gallery :global(.swiper-button-next:after) {
    font-size: 20px;
    font-weight: bold;
  }

  .project-gallery :global(.swiper-button-prev:hover),
  .project-gallery :global(.swiper-button-next:hover) {
    background: #0047AB;
    color: white;
  }

  .project-gallery :global(.swiper-pagination-bullet) {
    background: #0047AB;
    opacity: 0.5;
  }

  .project-gallery :global(.swiper-pagination-bullet-active) {
    opacity: 1;
    background: #FF5733;
  }
</style>

<script>
  import Swiper from 'swiper';
  import { Navigation, Pagination } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation';
  import 'swiper/css/pagination';

  // Initialize Swiper
  const swiper = new Swiper('.project-gallery', {
    modules: [Navigation, Pagination],
    loop: false,
    slidesPerView: 1,
    spaceBetween: 0,
    navigation: {
      nextEl: '.swiper-button-next',
      prevEl: '.swiper-button-prev',
    },
    pagination: {
      el: '.swiper-pagination',
      clickable: true,
    },
    keyboard: {
      enabled: true,
    },
    on: {
      slideChange: function () {
        // Update counter
        const currentSlideEl = document.querySelector('.current-slide');
        if (currentSlideEl) {
          currentSlideEl.textContent = String(this.activeIndex + 1);
        }
      },
    },
  });
</script>
